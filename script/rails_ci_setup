#!/usr/bin/env bash

config() {
  rvm_rubies=${RVM_RUBIES:-'1.8.6 1.8.7 1.9.2'}
  config_dir=~/.railsci
  mkdir -p $config_dir
}

install_packages() {
  echo "RAILSCI: Updating Aptitude..."
  sudo apt-get update
  echo "RAILSCI: Installing packages to build Ruby..."
  sudo apt-get install -y build-essential zlib1g zlib1g-dev libssl-dev openssl libreadline5-dev openssh-server openssh-client ssh wget
  echo "RAILSCI: Installing packages recommended by RVM..."
  sudo apt-get install -y bison libxml2-dev git-core
}

install_rvm() {
  echo "RAILSCI: Installing RVM..."
  curl -O http://rvm.beginrescueend.com/releases/rvm-install-latest
  chmod a+x rvm-install-latest
  ./rvm-install-latest
}

enable_rvm() {
  echo "RAILSCI: Enabling RVM in init file $init_file"
  rvm_init="if [[ -s $HOME/.rvm/scripts/rvm ]] ; then source $HOME/.rvm/scripts/rvm ; fi"
  if rvm_line=$(grep '.rvm' $init_file); test -z "$rvm_line"; then
    echo $rvm_init >> $init_file
  fi
  sed -i '.bak' -e 's/ && return.*$//' $init_file
  source $init_file
}

install_rvm_rubies() {
  for rvm_ruby in $rvm_rubies
  do
    echo "RAILSCI: Installing RVM ruby: $rvm_ruby"
    rvm install $rvm_ruby
  done
}

setup_rvm() {
  echo "RAILSCI: Setting up RVM..."
  install_rvm
  for init_file in ~/.bashrc ~/.bash_profile
  do
    if [[ -e $init_file ]]; then
      enable_rvm
    fi
  done
  install_rvm_rubies
}

setup_all() {
  echo "RAILSCI: Setting up Rails CI..."
  install_packages
  setup_rvm
}

config
setup_all
